<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nihongo Ascension: RPG Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Zen+Maru+Gothic:wght@500;700;900&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            transition: background-color 0.5s ease;
        }

        /* Theme: Void */
        body.theme-dark {
            background-color: #000000;
        }
        body.theme-dark aside {
            background-color: #050505;
            border-color: #333;
        }

        .font-jp { font-family: 'Zen Maru Gothic', sans-serif; }

        /* --- VFX --- */
        .boss-card {
            background: linear-gradient(160deg, #1a0b0b 0%, #2d1212 100%);
            border: 1px solid #7f1d1d;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
            transition: all 0.3s ease;
        }
        .boss-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.4);
            border-color: #ef4444;
        }
        .boss-locked { filter: grayscale(1) opacity(0.8); }

        .locked-item {
            filter: grayscale(1) brightness(0.5);
            opacity: 0.6;
            border: 1px dashed #475569;
        }
        .unlocked-item {
            filter: grayscale(0) brightness(1);
            opacity: 1;
            border: 1px solid #334155;
            background: #0f172a;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .fire-anim { animation: burn 0.8s infinite alternate; transform-origin: center bottom; }
        @keyframes burn {
            0% { transform: scale(1); filter: drop-shadow(0 0 2px orangered); }
            100% { transform: scale(1.1); filter: drop-shadow(0 0 5px yellow); }
        }

        .progress-bar-fill { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .custom-checkbox:checked + div { background-color: #10b981; border-color: #10b981; }
        .custom-checkbox:checked + div:after {
            content: '✓'; color: white; font-size: 10px; display: block; text-align: center;
        }
        /* Disabled State for Checkboxes */
        .checkbox-disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        /* Burnout Mode */
        .burnout-mode { filter: grayscale(0.8) sepia(0.2); }
        .burnout-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 0 rgba(255,0,0,0); }
            50% { box-shadow: inset 0 0 50px rgba(255,0,0,0.3); }
            100% { box-shadow: inset 0 0 0 rgba(255,0,0,0); }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row" id="main-body">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-80 bg-[#0B1121] border-r border-slate-800 flex flex-col z-20 shadow-2xl h-full transition-colors duration-500">
        
        <!-- Profile -->
        <div class="p-6 border-b border-slate-800/50 relative">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar Container -->
                    <div class="relative w-12 h-12 rounded bg-indigo-600 border border-indigo-400 shadow-[0_0_10px_rgba(99,102,241,0.5)] overflow-hidden flex items-center justify-center">
                        <span id="user-avatar" class="z-0 font-bold text-xl text-white">私</span>
                        <div id="burnout-overlay" class="absolute inset-0 bg-red-600/0 z-10 transition-colors duration-500 mix-blend-multiply"></div>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-wide">Ronin</h1>
                        <p class="text-slate-400 text-xs font-mono" id="current-rank-title">Nivel 1</p>
                    </div>
                </div>
                <!-- Streak -->
                <div class="text-center group cursor-help">
                    <div class="text-2xl relative inline-block">
                        <i class="fas fa-fire text-slate-700 transition-colors duration-300" id="streak-icon"></i>
                        <span class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold px-1.5 rounded-full border border-slate-900" id="streak-badge">0</span>
                    </div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase mt-1 group-hover:text-orange-400">Racha</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="space-y-3">
                <!-- Level Progress (Lifetime XP) -->
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Nivel (Progreso)</span>
                        <span id="xp-fraction">0 / 2,500</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                        <div id="xp-bar" class="progress-bar-fill bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Wallet (Spendable XP) -->
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span class="text-emerald-400 font-bold"><i class="fas fa-coins mr-1"></i>Cartera SP</span>
                        <span id="wallet-display" class="text-white font-mono">0 SP</span>
                    </div>
                </div>

                <!-- HP -->
                <div class="pt-1">
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Motivación (HP)</span>
                        <span id="hp-display">100%</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                        <div id="hp-bar" class="progress-bar-fill bg-gradient-to-r from-red-500 to-rose-500 h-2 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <div id="daily-status" class="mt-4 text-center text-[10px] font-bold uppercase tracking-widest text-slate-600 transition-colors">
                <i class="fas fa-circle text-[6px] mr-1"></i> Estado: Pendiente
            </div>
        </div>

        <!-- Actions -->
        <div class="p-4 flex-1 overflow-y-auto">
            <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">Grind Diario</h3>
            
            <div class="grid grid-cols-1 gap-3">
                <button onclick="addAction('anki')" class="group flex items-center justify-between bg-slate-800/50 hover:bg-blue-900/20 border border-slate-700 hover:border-blue-500 p-3 rounded transition-all">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-clone text-blue-400 group-hover:scale-110 transition-transform"></i>
                        <div class="text-left">
                            <div class="text-sm font-bold text-slate-300 group-hover:text-white">Anki Review</div>
                            <div class="text-[10px] text-slate-500">Mantenimiento</div>
                        </div>
                    </div>
                    <span class="text-xs font-mono text-blue-400">+150 SP</span>
                </button>

                <button onclick="addAction('immersion')" class="group flex items-center justify-between bg-slate-800/50 hover:bg-emerald-900/20 border border-slate-700 hover:border-emerald-500 p-3 rounded transition-all">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-play text-emerald-400 group-hover:scale-110 transition-transform"></i>
                        <div class="text-left">
                            <div class="text-sm font-bold text-slate-300 group-hover:text-white">Inmersión</div>
                            <div class="text-[10px] text-slate-500">Anime / Novela</div>
                        </div>
                    </div>
                    <span class="text-xs font-mono text-emerald-400">+300 SP</span>
                </button>

                <!-- Simulators -->
                <div class="mt-4 pt-4 border-t border-slate-800">
                    <h3 class="text-slate-600 text-[10px] font-bold uppercase mb-2">Simulador de Tiempo</h3>
                    <button onclick="endDay()" class="w-full text-xs bg-slate-800 text-slate-400 hover:text-white hover:bg-indigo-900/30 py-3 rounded border border-slate-700 transition-all relative overflow-hidden group">
                        <span class="relative z-10"><i class="fas fa-moon mr-1"></i> Dormir (Terminar Día)</span>
                        <div class="absolute inset-0 bg-indigo-600/10 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                    </button>
                    <p class="text-[8px] text-slate-600 mt-2 text-center">⚠️ Si duermes sin estudiar, pierdes racha.</p>
                </div>
            </div>

            <!-- Shop -->
            <div class="mt-8 border-b border-slate-800 pb-6">
                <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">Mercado Negro (Gasta SP)</h3>
                <div id="shop-container" class="space-y-2">
                    <!-- Injected JS -->
                </div>
            </div>

            <!-- DATA MANAGEMENT AREA -->
            <div class="mt-8 pb-6">
                <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3">Sistema de Guardado</h3>
                <div class="flex gap-2">
                    <button onclick="exportSave()" class="flex-1 bg-slate-800 text-[10px] text-slate-300 py-2 rounded hover:bg-indigo-600 hover:text-white transition border border-slate-700">
                        <i class="fas fa-file-export mr-1"></i> Exportar
                    </button>
                    <button onclick="importSave()" class="flex-1 bg-slate-800 text-[10px] text-slate-300 py-2 rounded hover:bg-emerald-600 hover:text-white transition border border-slate-700">
                        <i class="fas fa-file-import mr-1"></i> Importar
                    </button>
                </div>
                <p class="text-[8px] text-slate-600 mt-2">Copia el código generado y guárdalo en un bloc de notas para respaldo manual.</p>
            </div>
        </div>
    </aside>

    <!-- MAIN ROADMAP -->
    <main class="flex-1 relative overflow-y-auto custom-scrollbar transition-colors duration-500">
        
        <!-- Background Grid -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#4f46e5 1px, transparent 1px); background-size: 30px 30px;"></div>

        <div class="relative max-w-5xl mx-auto p-6 md:p-12">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-black text-white mb-2 font-jp tracking-tight">CAMINO A LA <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">FLUIDEZ</span></h2>
                <p class="text-slate-400 max-w-xl mx-auto">Completa los requisitos obligatorios. <br><span class="text-xs text-yellow-500/70 uppercase tracking-widest">Nota: Los objetivos solo se desbloquean al alcanzar la XP necesaria.</span></p>
            </div>

            <div class="absolute left-6 md:left-1/2 top-40 bottom-20 w-0.5 bg-slate-800 md:-translate-x-1/2 z-0"></div>

            <div id="roadmap-container" class="space-y-16 relative z-10">
                <!-- Injected JS -->
            </div>
            <div class="h-20"></div>
        </div>
    </main>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-8 right-8 max-w-sm bg-slate-900 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-4 border-l-4 border-indigo-500 z-50">
        <div class="text-2xl" id="toast-icon"><i class="fas fa-info-circle"></i></div>
        <div>
            <h4 class="font-bold text-sm uppercase" id="toast-title">Notificación</h4>
            <p id="toast-message" class="text-xs text-slate-400">Mensaje del sistema.</p>
        </div>
    </div>

    <script>
        // --- GAME DATA ENGINE ---
        let GAME_DATA = {
            lifetimeXP: 0,  
            walletXP: 0,    
            streak: 0,
            hp: 100, 
            hasStudiedToday: false, 
            inventory: {
                streakFreeze: false,
                themeDark: false
            },
            milestones: [
                {
                    id: 1, xp_req: 0, title: "El Despertar", subtitle: "Tutorial (Semana 1)",
                    desc: "El comienzo del viaje. Configura tu entorno.", icon: "fa-seedling", isBoss: false,
                    checklist: [
                        { id: 'm1_1', text: "Instalar Anki + Yomitan", done: false },
                        { id: 'm1_2', text: "Aprender Hiragana/Katakana", done: false }
                    ]
                },
                {
                    id: 2, xp_req: 13500, title: "Supervivencia N5", subtitle: "Mes 1: Cimientos",
                    desc: "El primer mes. Construyes la base estructural y de lectura básica.", icon: "fa-shield-alt", isBoss: false,
                    checklist: [
                        { id: 'm2_1', text: "Terminar Tae Kim (Básico)", done: false },
                        { id: 'm2_2', text: "Leer 5 caps de Satori Reader", done: false }
                    ]
                },
                {
                    id: 3, xp_req: 85000, title: "El Gran Filtro", subtitle: "GATEKEEPER (Meses 2-6)",
                    desc: "La travesía del desierto. 150 días de consistencia para terminar el mazo básico.", icon: "fa-torii-gate", isBoss: true, 
                    checklist: [
                        { id: 'm3_1', text: "COMPLETAR Kaishi 1.5k (Entero)", done: false },
                        { id: 'm3_2', text: "Ver 'Shirokuma Cafe' (5 eps)", done: false }
                    ]
                },
                {
                    id: 4, xp_req: 150000, title: "Minero de Datos", subtitle: "Transición (Meses 6-9)",
                    desc: "Libertad. Ya no dependes de mazos prefabricados. Minería propia.", icon: "fa-database", isBoss: false,
                    checklist: [
                        { id: 'm4_1', text: "Configurar Textractor", done: false },
                        { id: 'm4_2', text: "Leer 'Go! Go! Nippon!'", done: false }
                    ]
                },
                {
                    id: 5, xp_req: 300000, title: "LA PRUEBA EMOCIONAL", subtitle: "BOSS: CLANNAD (Año 1+)",
                    desc: "Una obra monumental. Te llevará meses terminarla. El verdadero examen.", icon: "fa-heart-broken", isBoss: true,
                    checklist: [
                        { id: 'm5_1', text: "Deck Vocab Clannad (jpdb.io)", done: false },
                        { id: 'm5_2', text: "Completar Ruta Nagisa", done: false }
                    ]
                },
                {
                    id: 6, xp_req: 600000, title: "Nativo Honorario", subtitle: "Alta Inmersión",
                    desc: "Consumes contenido sin subtítulos con fluidez relativa.", icon: "fa-dragon", isBoss: false,
                    checklist: [
                        { id: 'm6_1', text: "Leer White Album 2", done: false },
                        { id: 'm6_2', text: "Leer 1 Novela de Mishima", done: false }
                    ]
                },
                {
                    id: 7, xp_req: 1000000, title: "GOD TIER: JLPT N1", subtitle: "Objetivo Final",
                    desc: "La cima de la montaña. Años de dedicación.", icon: "fa-crown", isBoss: true,
                    checklist: [
                        { id: 'm7_1', text: "Aprobar Simulacro N1", done: false },
                        { id: 'm7_2', text: "Quemar 10k cartas", done: false }
                    ]
                }
            ],
            shop: [
                { id: 'freeze', name: "Escudo de Racha", desc: "Protege 1 día perdido.", cost: 5000, icon: "fa-snowflake", type: 'consumable' },
                { id: 'potion', name: "Poción de Motivación", desc: "+30 HP al instante.", cost: 1000, icon: "fa-flask", type: 'consumable' },
                { id: 'theme_dark', name: "Protocolo VOID", desc: "Modo visual oscuro total.", cost: 20000, icon: "fa-moon", type: 'cosmetic' }
            ]
        };

        // --- LOGIC ENGINE ---

        function isMilestoneUnlocked(m) {
            const xpMet = GAME_DATA.lifetimeXP >= m.xp_req;
            const allTasksDone = m.checklist.every(task => task.done);
            return xpMet && allTasksDone;
        }

        function isCurrentGoal(index) {
            if (index === 0) return !isMilestoneUnlocked(GAME_DATA.milestones[0]);
            const prev = GAME_DATA.milestones[index - 1];
            const curr = GAME_DATA.milestones[index];
            return isMilestoneUnlocked(prev) && !isMilestoneUnlocked(curr);
        }

        function addAction(type) {
            let gain = 0;
            if (type === 'anki') gain = 150;
            if (type === 'immersion') gain = 300;

            GAME_DATA.lifetimeXP += gain;
            GAME_DATA.walletXP += gain;
            GAME_DATA.hasStudiedToday = true;
            
            saveData();
            renderAll();
            showToast(`+${gain} SP (Progreso & Cartera)`, 'success');
        }

        function toggleTask(milestoneId, taskId) {
            const milestone = GAME_DATA.milestones.find(m => m.id === milestoneId);
            const task = milestone.checklist.find(t => t.id === taskId);
            
            const mIndex = GAME_DATA.milestones.indexOf(milestone);
            const prevUnlocked = mIndex === 0 || isMilestoneUnlocked(GAME_DATA.milestones[mIndex - 1]);
            const xpMet = GAME_DATA.lifetimeXP >= milestone.xp_req;

            if (prevUnlocked && xpMet) {
                task.done = !task.done;
                saveData();
                renderAll();
                if (isMilestoneUnlocked(milestone)) {
                    showToast(`¡NIVEL ${milestone.title} COMPLETADO!`, 'levelup');
                }
            } else {
                if (!prevUnlocked) showToast("¡Completa el nivel anterior primero!", "error");
                else if (!xpMet) showToast("¡Necesitas más XP para completar este nivel!", "error");
            }
        }

        function buyItem(itemId) {
            const item = GAME_DATA.shop.find(i => i.id === itemId);
            if (GAME_DATA.walletXP >= item.cost) {
                if (itemId === 'freeze' && GAME_DATA.inventory.streakFreeze) { showToast("Ya tienes un escudo activo", "error"); return; }
                if (itemId === 'theme_dark' && GAME_DATA.inventory.themeDark) { showToast("Ya posees este tema", "error"); return; }
                
                GAME_DATA.walletXP -= item.cost;
                
                if (itemId === 'freeze') GAME_DATA.inventory.streakFreeze = true;
                if (itemId === 'potion') GAME_DATA.hp = Math.min(100, GAME_DATA.hp + 30);
                if (itemId === 'theme_dark') GAME_DATA.inventory.themeDark = true;
                
                saveData();
                renderAll();
                showToast(`Compraste: ${item.name}`, 'success');
            } else {
                showToast(`Necesitas ${item.cost} SP en cartera`, "error");
            }
        }

        function endDay() {
            if (GAME_DATA.hasStudiedToday) {
                GAME_DATA.streak++;
                GAME_DATA.hasStudiedToday = false;
                if (GAME_DATA.hp < 100) GAME_DATA.hp = Math.min(100, GAME_DATA.hp + 2);
                showToast("Día registrado. +2% HP", "success");
            } else {
                if (GAME_DATA.inventory.streakFreeze) {
                    GAME_DATA.inventory.streakFreeze = false;
                    GAME_DATA.hasStudiedToday = false;
                    showToast("¡Escudo usado! Racha salvada.", "warning");
                } else {
                    GAME_DATA.streak = 0;
                    GAME_DATA.hp = Math.max(0, GAME_DATA.hp - 20);
                    GAME_DATA.hasStudiedToday = false;
                    showToast("¡Día perdido! Racha 0. -20 HP", "error");
                }
            }
            saveData();
            renderAll();
        }

        // --- MANUAL EXPORT/IMPORT SYSTEM (NEW) ---
        function exportSave() {
            const dataStr = JSON.stringify(GAME_DATA);
            const encoded = btoa(dataStr); // Base64 encode simple
            
            // Copy to clipboard
            navigator.clipboard.writeText(encoded).then(() => {
                showToast("Código de guardado copiado al portapapeles", "success");
            }).catch(() => {
                prompt("Copia tu código de guardado:", encoded);
            });
        }

        function importSave() {
            const input = prompt("Pega tu código de guardado aquí:");
            if (!input) return;

            try {
                const decoded = atob(input);
                const parsed = JSON.parse(decoded);
                
                // Basic Validation
                if (parsed.lifetimeXP === undefined || parsed.milestones === undefined) {
                    throw new Error("Formato inválido");
                }

                GAME_DATA = parsed;
                saveData(); // Persist immediately
                renderAll();
                showToast("Datos cargados correctamente", "success");
            } catch (e) {
                showToast("Error: Código de guardado inválido", "error");
                console.error(e);
            }
        }

        // --- RENDER ENGINE ---

        function renderAll() {
            renderSidebar();
            renderRoadmap();
            renderShop();
            applyVisuals();
        }

        function applyVisuals() {
            const body = document.getElementById('main-body');
            const avatarOverlay = document.getElementById('burnout-overlay');
            if (GAME_DATA.hp <= 0) {
                body.classList.add('burnout-mode');
                avatarOverlay.classList.remove('bg-red-600/0');
                avatarOverlay.classList.add('bg-red-600/60'); 
                document.getElementById('hp-display').innerText = "AGOTADO";
            } else {
                body.classList.remove('burnout-mode');
                avatarOverlay.classList.add('bg-red-600/0');
                avatarOverlay.classList.remove('bg-red-600/60');
            }
            if (GAME_DATA.inventory.themeDark) body.classList.add('theme-dark');
            else body.classList.remove('theme-dark');
        }

        function renderSidebar() {
            document.getElementById('streak-badge').innerText = GAME_DATA.streak;
            const fire = document.getElementById('streak-icon');
            if(GAME_DATA.streak > 3) { fire.classList.add('fire-anim', 'text-orange-500'); fire.classList.remove('text-slate-700'); } 
            else { fire.classList.remove('fire-anim', 'text-orange-500'); fire.classList.add('text-slate-700'); }

            const statusDiv = document.getElementById('daily-status');
            if (GAME_DATA.hasStudiedToday) {
                statusDiv.innerHTML = '<i class="fas fa-check-circle text-emerald-500 mr-1"></i> Completado';
                statusDiv.classList.replace('text-slate-600', 'text-emerald-400');
            } else {
                statusDiv.innerHTML = '<i class="fas fa-circle text-slate-600 mr-1"></i> Pendiente';
                statusDiv.classList.replace('text-emerald-400', 'text-slate-600');
            }

            document.getElementById('wallet-display').innerText = `${GAME_DATA.walletXP.toLocaleString()} SP`;

            let activeIdx = GAME_DATA.milestones.findIndex(m => !isMilestoneUnlocked(m));
            if (activeIdx === -1) {
                document.getElementById('xp-bar').style.width = "100%";
                document.getElementById('xp-fraction').innerText = "MAESTRO JAPONÉS";
                document.getElementById('current-rank-title').innerText = "JLPT N1 God";
            } else {
                const currentM = GAME_DATA.milestones[activeIdx];
                const prevReq = activeIdx > 0 ? GAME_DATA.milestones[activeIdx - 1].xp_req : 0;
                const nextReq = currentM.xp_req;
                const range = nextReq - prevReq;
                const currentProgress = GAME_DATA.lifetimeXP - prevReq;
                
                let pct = 0;
                let statusText = "";

                if (range <= 0) {
                    pct = 100; statusText = "¡Misión requerida!";
                } else {
                    pct = (currentProgress / range) * 100;
                    if (GAME_DATA.lifetimeXP >= nextReq) {
                        pct = 100; statusText = "XP Lista - ¡Checklist!";
                    } else {
                        statusText = `${Math.floor(GAME_DATA.lifetimeXP).toLocaleString()} / ${nextReq.toLocaleString()}`;
                    }
                }
                pct = Math.min(100, Math.max(0, pct));

                document.getElementById('xp-bar').style.width = `${pct}%`;
                document.getElementById('xp-fraction').innerText = statusText;
                document.getElementById('current-rank-title').innerText = activeIdx > 0 ? GAME_DATA.milestones[activeIdx-1].title : "Novato";
            }

            const hpVal = Math.max(0, GAME_DATA.hp);
            document.getElementById('hp-display').innerText = `${hpVal}%`;
            const hpBar = document.getElementById('hp-bar');
            hpBar.style.width = `${hpVal}%`;
            if(hpVal < 30) hpBar.className = "progress-bar-fill bg-red-600 h-2 rounded-full";
            else hpBar.className = "progress-bar-fill bg-gradient-to-r from-emerald-400 to-green-500 h-2 rounded-full";
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmap-container');
            container.innerHTML = '';

            GAME_DATA.milestones.forEach((m, index) => {
                const unlocked = isMilestoneUnlocked(m);
                const current = isCurrentGoal(index);
                
                const xpMet = GAME_DATA.lifetimeXP >= m.xp_req;
                
                let cardClass = unlocked ? "unlocked-item" : "locked-item";
                if (m.isBoss) cardClass = unlocked ? "boss-card border-red-500" : "boss-card boss-locked";
                if (current) cardClass += " border-2 border-yellow-500 shadow-[0_0_25px_rgba(234,179,8,0.2)]";

                let alignClass = index % 2 === 0 ? "md:ml-auto md:pl-12" : "md:mr-auto md:pr-12";
                if (m.isBoss) alignClass = "md:mx-auto md:w-3/4 md:px-0";
                else alignClass += " md:w-5/12";

                const checklistHTML = m.checklist.map(task => `
                    <label class="flex items-center space-x-3 group p-1 rounded transition ${xpMet ? 'cursor-pointer hover:bg-slate-800/50' : 'checkbox-disabled'}">
                        <input type="checkbox" class="hidden custom-checkbox" 
                            ${task.done ? 'checked' : ''} 
                            onchange="toggleTask(${m.id}, '${task.id}')">
                        <div class="w-4 h-4 border border-slate-500 rounded bg-slate-900 transition-colors ${!xpMet ? 'opacity-30' : ''}"></div>
                        <span class="text-xs ${task.done ? 'text-emerald-400 line-through decoration-emerald-500/50' : 'text-slate-400 group-hover:text-slate-200'} select-none">${task.text}</span>
                    </label>
                `).join('');

                const html = `
                <div class="relative flex items-center justify-center w-full">
                    <div class="absolute left-6 md:left-1/2 transform md:-translate-x-1/2 w-4 h-4 rounded-full ${unlocked ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-slate-800 border border-slate-600'} z-20 transition-all duration-500"></div>
                    <div class="${alignClass} w-full pl-16 md:pl-0 transition-all duration-500">
                        <div class="p-6 rounded-xl ${cardClass} relative overflow-hidden group">
                            ${current ? '<div class="absolute top-0 right-0 bg-yellow-500 text-black text-[10px] font-bold px-2 py-1 z-10">OBJETIVO</div>' : ''}
                            <div class="flex items-start justify-between mb-4 relative z-10">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl ${unlocked ? (m.isBoss ? 'text-red-500' : 'text-emerald-400') : 'text-slate-600'}"><i class="fas ${m.icon}"></i></div>
                                    <div>
                                        <h3 class="font-bold text-lg text-slate-200 ${m.isBoss ? 'uppercase tracking-widest text-red-100' : ''}">${m.title}</h3>
                                        <p class="text-[10px] uppercase tracking-wider text-slate-500 font-bold">${m.subtitle}</p>
                                    </div>
                                </div>
                                <div class="text-xs font-mono text-slate-500 bg-slate-950/50 px-2 py-1 rounded border border-slate-800 ${xpMet ? 'text-emerald-400 border-emerald-900' : ''}">${m.xp_req.toLocaleString()} SP</div>
                            </div>
                            <p class="text-sm text-slate-400 mb-4 italic border-l-2 border-slate-700 pl-3 relative z-10">${m.desc}</p>
                            <div class="bg-black/30 rounded p-3 border border-slate-800/50 relative z-10">
                                <p class="text-[10px] font-bold text-slate-500 uppercase mb-2 flex justify-between">
                                    Requisitos:
                                    ${!xpMet ? '<span class="text-red-400 text-[9px]"><i class="fas fa-lock mr-1"></i>XP Insuficiente</span>' : ''}
                                </p>
                                <div class="space-y-2">${checklistHTML}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function renderShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            GAME_DATA.shop.forEach(item => {
                const canAfford = GAME_DATA.walletXP >= item.cost;
                let isOwned = false;
                if (item.id === 'freeze' && GAME_DATA.inventory.streakFreeze) isOwned = true;
                if (item.id === 'theme_dark' && GAME_DATA.inventory.themeDark) isOwned = true;

                container.innerHTML += `
                <div class="bg-slate-800 p-3 rounded border border-slate-700 flex justify-between items-center ${canAfford || isOwned ? 'opacity-100' : 'opacity-60'}">
                    <div class="flex items-center gap-3">
                        <div class="text-slate-400 w-6 text-center"><i class="fas ${item.icon}"></i></div>
                        <div>
                            <div class="text-xs font-bold text-white">${item.name}</div>
                            <div class="text-[10px] text-slate-500">${item.cost.toLocaleString()} SP</div>
                        </div>
                    </div>
                    <button onclick="buyItem('${item.id}')" 
                        class="text-[10px] px-3 py-1.5 rounded font-bold transition-colors ${
                            isOwned ? 'bg-emerald-900 text-emerald-400 cursor-default' : 
                            (canAfford ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed')
                        }"
                        ${!canAfford || isOwned ? 'disabled' : ''}>${isOwned ? 'EN INVENTARIO' : 'COMPRAR'}</button>
                </div>`;
            });
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const title = document.getElementById('toast-title');
            const body = document.getElementById('toast-message');
            const icon = document.getElementById('toast-icon');
            body.innerText = msg;
            
            toast.className = "fixed bottom-8 right-8 max-w-sm px-6 py-4 rounded-lg shadow-2xl flex items-center gap-4 border-l-4 z-50 transition-all duration-500 transform";
            
            if(type === 'success') {
                toast.classList.add('bg-slate-900', 'text-white', 'border-emerald-500');
                icon.innerHTML = '<i class="fas fa-check text-emerald-400"></i>';
                title.innerText = "Éxito";
            } else if (type === 'error') {
                toast.classList.add('bg-slate-900', 'text-white', 'border-red-500');
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                title.innerText = "Error";
            } else if (type === 'warning') {
                toast.classList.add('bg-slate-900', 'text-white', 'border-yellow-500');
                icon.innerHTML = '<i class="fas fa-shield-alt text-yellow-500"></i>';
                title.innerText = "Aviso";
            } else if (type === 'levelup') {
                toast.classList.add('bg-yellow-900', 'text-yellow-100', 'border-yellow-400');
                icon.innerHTML = '<i class="fas fa-crown text-yellow-400 animate-bounce"></i>';
                title.innerText = "LEVEL UP!";
            }
            
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        function saveData() {
            localStorage.setItem('nihongo_v4', JSON.stringify({
                lifetimeXP: GAME_DATA.lifetimeXP,
                walletXP: GAME_DATA.walletXP,
                streak: GAME_DATA.streak,
                hp: GAME_DATA.hp,
                inventory: GAME_DATA.inventory,
                hasStudiedToday: GAME_DATA.hasStudiedToday,
                checklistState: GAME_DATA.milestones.map(m => ({ id: m.id, checklist: m.checklist }))
            }));
        }

        function loadData() {
            let saved = localStorage.getItem('nihongo_v4');
            if (!saved) {
                const oldSaved = localStorage.getItem('nihongo_v3');
                if (oldSaved) {
                    const parsedOld = JSON.parse(oldSaved);
                    GAME_DATA.lifetimeXP = parsedOld.lifetimeXP || 0;
                    GAME_DATA.walletXP = parsedOld.walletXP || 0;
                    GAME_DATA.streak = parsedOld.streak || 0;
                    GAME_DATA.hp = parsedOld.hp || 100;
                    GAME_DATA.inventory = parsedOld.inventory || {};
                    if (parsedOld.checklistState) restoreChecklist(parsedOld.checklistState);
                    return; 
                }
            }
            if (saved) {
                const parsed = JSON.parse(saved);
                GAME_DATA.lifetimeXP = parsed.lifetimeXP || 0;
                GAME_DATA.walletXP = parsed.walletXP !== undefined ? parsed.walletXP : parsed.lifetimeXP;
                GAME_DATA.streak = parsed.streak || 0;
                GAME_DATA.hp = (parsed.hp !== undefined) ? parsed.hp : 100;
                GAME_DATA.hasStudiedToday = parsed.hasStudiedToday || false;
                GAME_DATA.inventory = parsed.inventory || { streakFreeze: false, themeDark: false };
                if(parsed.checklistState) restoreChecklist(parsed.checklistState);
            }
        }

        function restoreChecklist(savedState) {
            savedState.forEach(savedM => {
                const originalM = GAME_DATA.milestones.find(m => m.id === savedM.id);
                if(originalM) {
                    savedM.checklist.forEach(savedTask => {
                        const originalTask = originalM.checklist.find(t => t.id === savedTask.id);
                        if(originalTask) originalTask.done = savedTask.done;
                    });
                }
            });
        }

        loadData();
        renderAll();

    </script>
</body>
</html>